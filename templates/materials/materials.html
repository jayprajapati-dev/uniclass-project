{% extends 'base.html' %}

{% block title %}Study Materials{% endblock %}

{% block content %}
<div class="container-fluid px-3 px-sm-4 mt-3 mt-sm-4">
    <!-- Header Section -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 mb-0">Study Materials</h1>
        {% if current_user.is_authenticated %}
        <button class="btn btn-success d-flex align-items-center gap-2" type="button" data-bs-toggle="collapse" data-bs-target="#uploadForm" aria-expanded="false" aria-controls="uploadForm">
            <i class="fas fa-plus-circle"></i>
            <span>Upload Material</span>
        </button>
        {% else %}
        <a href="{{ url_for('auth.login') }}" class="btn btn-success d-flex align-items-center gap-2">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login to Upload</span>
        </a>
        {% endif %}
    </div>

    <!-- Search and Filter Section -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light py-3">
            <div class="d-flex align-items-center gap-2">
                <i class="fas fa-search text-primary"></i>
                <h5 class="mb-0">Search Materials</h5>
            </div>
        </div>
        <div class="card-body">
            <form method="GET" class="row g-3">
                <div class="col-12 col-sm-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="fas fa-search text-muted"></i>
                        </span>
                        <input type="text" name="search" class="form-control border-start-0" placeholder="Search materials..." value="{{ request.args.get('search', '') }}">
                    </div>
                </div>
                <div class="col-6 col-sm-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="fas fa-book text-muted"></i>
                        </span>
                        <select name="subject" class="form-select border-start-0">
                            <option value="">All Subjects</option>
                            <option value="Data Structures" {% if request.args.get('subject') == 'Data Structures' %}selected{% endif %}>Data Structures</option>
                            <option value="Database Management" {% if request.args.get('subject') == 'Database Management' %}selected{% endif %}>Database Management</option>
                            <option value="Computer Networks" {% if request.args.get('subject') == 'Computer Networks' %}selected{% endif %}>Computer Networks</option>
                            <option value="Operating Systems" {% if request.args.get('subject') == 'Operating Systems' %}selected{% endif %}>Operating Systems</option>
                        </select>
                    </div>
                </div>
                <div class="col-6 col-sm-3">
                    <div class="input-group">
                        <span class="input-group-text bg-light border-end-0">
                            <i class="fas fa-file-alt text-muted"></i>
                        </span>
                        <select name="material_type" class="form-select border-start-0">
                            <option value="">All Types</option>
                            <option value="Book" {% if request.args.get('material_type') == 'Book' %}selected{% endif %}>Book</option>
                            <option value="Notes" {% if request.args.get('material_type') == 'Notes' %}selected{% endif %}>Notes</option>
                            <option value="Question Paper" {% if request.args.get('material_type') == 'Question Paper' %}selected{% endif %}>Question Paper</option>
                            <option value="Study Guide" {% if request.args.get('material_type') == 'Study Guide' %}selected{% endif %}>Study Guide</option>
                            <option value="Other" {% if request.args.get('material_type') == 'Other' %}selected{% endif %}>Other</option>
                        </select>
                    </div>
                </div>
                <div class="col-12 col-sm-2">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="fas fa-search d-sm-none"></i>
                        <span class="d-none d-sm-inline">Search</span>
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Upload Form -->
    {% if current_user.is_authenticated %}
    <div class="collapse mb-4" id="uploadForm">
        <div class="card shadow-sm">
            <div class="card-header bg-light py-3">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-upload text-primary"></i>
                    <h5 class="mb-0">Upload New Material</h5>
                </div>
            </div>
            <div class="card-body p-3">
                <form method="POST" action="{{ url_for('materials.create') }}" enctype="multipart/form-data" class="row g-3">
                    {{ form.csrf_token }}
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Title</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-heading text-muted"></i>
                            </span>
                            <input type="text" name="title" class="form-control border-start-0" required>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Subject</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-book text-muted"></i>
                            </span>
                            <input type="text" name="subject" class="form-control border-start-0" required>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Material Type</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-file-alt text-muted"></i>
                            </span>
                            <select name="material_type" class="form-select border-start-0" required>
                                <option value="Book">Book</option>
                                <option value="Notes">Notes</option>
                                <option value="Question Paper">Question Paper</option>
                                <option value="Study Guide">Study Guide</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Price (â‚¹)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-rupee-sign text-muted"></i>
                            </span>
                            <input type="number" name="price" class="form-control border-start-0" min="0" step="0.01" required>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6">
                        <label class="form-label">Condition</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-tag text-muted"></i>
                            </span>
                            <select name="condition" class="form-select border-start-0" required>
                                <option value="New">New</option>
                                <option value="Like New">Like New</option>
                                <option value="Good">Good</option>
                                <option value="Fair">Fair</option>
                            </select>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Description</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-align-left text-muted"></i>
                            </span>
                            <textarea name="description" class="form-control border-start-0" rows="3" required></textarea>
                        </div>
                    </div>
                    <div class="col-12">
                        <label class="form-label">Material Image</label>
                        <div class="input-group">
                            <span class="input-group-text bg-light border-end-0">
                                <i class="fas fa-image text-muted"></i>
                            </span>
                            <input type="file" name="image" class="form-control border-start-0" accept="image/*">
                        </div>
                    </div>
                    <div class="col-12 mt-3 d-flex gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-upload me-1"></i>
                            Upload Material
                        </button>
                        <button type="button" class="btn btn-secondary" data-bs-toggle="collapse" data-bs-target="#uploadForm">
                            <i class="fas fa-times me-1"></i>
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Materials Grid -->
    <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 g-3">
        {% for material in materials %}
        <div class="col">
            <div class="card h-100 shadow-sm hover-shadow">
                {% if material.image_path %}
                <div class="position-relative">
                    <img src="{{ url_for('static', filename=material.image_path) }}" class="card-img-top" alt="{{ material.title }}" style="height: 180px; object-fit: cover;">
                    <div class="position-absolute top-0 end-0 m-2">
                        <span class="badge bg-{{ 'success' if material.condition == 'New' else 'info' if material.condition == 'Like New' else 'warning' if material.condition == 'Good' else 'secondary' }}">
                            {{ material.condition }}
                        </span>
                    </div>
                    <div class="position-absolute bottom-0 start-0 w-100 p-2" style="background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);">
                        <h6 class="card-title mb-0 text-white text-truncate">{{ material.title }}</h6>
                    </div>
                </div>
                {% else %}
                <div class="card-img-top bg-light d-flex align-items-center justify-content-center" style="height: 180px;">
                    <i class="fas fa-book fa-2x text-muted"></i>
                </div>
                {% endif %}
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="card-text text-muted mb-0">
                            <i class="fas fa-book me-1"></i>
                            {{ material.subject }}
                        </p>
                        <span class="badge bg-info">
                            <i class="fas fa-file-alt me-1"></i>
                            {{ material.material_type }}
                        </span>
                    </div>
                    <p class="card-text mb-3" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">
                        {{ material.description }}
                    </p>
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="text-primary fw-bold">â‚¹{{ "%.2f"|format(material.price) }}</span>
                        {% if current_user.is_authenticated %}
                        <button class="btn btn-primary buy-now-btn" data-material-id="{{ material.id }}" data-bs-toggle="modal" data-bs-target="#buyConfirmationModal">
                            <i class="fas fa-shopping-cart me-1"></i>
                            Buy Now
                        </button>
                        {% else %}
                        <a href="{{ url_for('auth.login') }}" class="btn btn-primary">
                            <i class="fas fa-sign-in-alt me-1"></i>
                            Login to Buy
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="col-12">
            <div class="alert alert-info py-3 mb-0">
                <div class="d-flex align-items-center gap-2">
                    <i class="fas fa-info-circle fa-lg"></i>
                    <div>
                        <h6 class="mb-1">No Materials Found</h6>
                        <p class="mb-0">Be the first to upload study materials!</p>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Buy Confirmation Modal -->
<div class="modal fade" id="buyConfirmationModal" tabindex="-1" aria-labelledby="buyConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="buyConfirmationModalLabel">Confirm Purchase</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to purchase this material?</p>
                <div id="sellerContactInfo" class="alert alert-info d-none">
                    <h6 class="mb-2">Seller Contact Information:</h6>
                    <p class="mb-1"><i class="fas fa-phone me-2"></i><span id="sellerPhone"></span></p>
                    <p class="mb-0"><i class="fas fa-envelope me-2"></i><span id="sellerEmail"></span></p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="purchaseForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-primary" id="confirmBuyBtn">
                        <i class="fas fa-check me-1"></i>
                        Confirm Purchase
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Modal -->
<div class="modal fade" id="transactionModal" tabindex="-1" aria-labelledby="transactionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="transactionModalLabel">Transaction Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="text-center">
                    <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
                    <h5>Purchase Request Submitted!</h5>
                    <p class="mb-0">The seller will contact you shortly with payment details.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Close the upload form when clicking outside
    const uploadForm = document.getElementById('uploadForm');
    const uploadButton = document.querySelector('[data-bs-target="#uploadForm"]');
    
    // Create a backdrop for the form
    const backdrop = document.createElement('div');
    backdrop.className = 'modal-backdrop fade';
    backdrop.style.display = 'none';
    document.body.appendChild(backdrop);

    // Handle form toggle
    uploadButton.addEventListener('click', function() {
        const isExpanded = this.getAttribute('aria-expanded') === 'true';
        if (isExpanded) {
            // Closing the form
            const bsCollapse = new bootstrap.Collapse(uploadForm);
            bsCollapse.hide();
            backdrop.classList.remove('show');
            setTimeout(() => backdrop.style.display = 'none', 150);
        } else {
            // Opening the form
            const bsCollapse = new bootstrap.Collapse(uploadForm);
            bsCollapse.show();
            backdrop.style.display = 'block';
            setTimeout(() => backdrop.classList.add('show'), 10);
        }
    });

    // Close form when clicking backdrop
    backdrop.addEventListener('click', function() {
        const bsCollapse = new bootstrap.Collapse(uploadForm);
        bsCollapse.hide();
        backdrop.classList.remove('show');
        setTimeout(() => backdrop.style.display = 'none', 150);
    });

    // Buy Now Button Handler
    const buyButtons = document.querySelectorAll('.buy-now-btn');
    const buyModal = document.getElementById('buyConfirmationModal');
    const transactionModal = document.getElementById('transactionModal');
    const confirmBuyBtn = document.getElementById('confirmBuyBtn');
    const sellerContactInfo = document.getElementById('sellerContactInfo');
    const sellerPhone = document.getElementById('sellerPhone');
    const sellerEmail = document.getElementById('sellerEmail');
    let contactInfoTimer = null;

    buyButtons.forEach(button => {
        button.addEventListener('click', function() {
            const materialId = this.dataset.materialId;
            const purchaseForm = document.getElementById('purchaseForm');
            purchaseForm.action = `/materials/${materialId}/purchase`;
            
            // Show seller contact info after 3 seconds
            contactInfoTimer = setTimeout(() => {
                sellerContactInfo.classList.remove('d-none');
                // In a real application, you would fetch this from the server
                sellerPhone.textContent = '+91 98765 43210';
                sellerEmail.textContent = 'seller@example.com';
            }, 3000);
        });
    });

    // Handle purchase confirmation
    confirmBuyBtn.addEventListener('click', function(e) {
        e.preventDefault();
        const form = this.closest('form');
        fetch(form.action, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('meta[name="csrf-token"]').content
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                buyModal.classList.remove('show');
                setTimeout(() => {
                    transactionModal.classList.add('show');
                }, 150);
            } else {
                alert(data.message || 'Error processing purchase');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error processing purchase');
        });
    });

    // Reset modals when closed
    [buyModal, transactionModal].forEach(modal => {
        modal.addEventListener('hidden.bs.modal', function() {
            sellerContactInfo.classList.add('d-none');
            if (contactInfoTimer) {
                clearTimeout(contactInfoTimer);
                contactInfoTimer = null;
            }
        });
    });
});
</script>
{% endblock %} 